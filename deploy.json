{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.14.6.61914",
      "templateHash": "13685125061666166978"
    }
  },
  "parameters": {
    "serviceCatalog": {
      "type": "bool",
      "defaultValue": false
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    },
    "eventHubConnectionString": {
      "type": "securestring"
    },
    "storageAccountConnectionString": {
      "type": "securestring"
    },
    "offsetContainerName": {
      "type": "string"
    },
    "applicationInsightsConnectionString": {
      "type": "securestring"
    }
  },
  "variables": {
    "managedGroupId": "[format('{0}-resources-{1}', resourceGroup().id, uniqueString(resourceGroup().id))]",
    "kind": "[if(parameters('serviceCatalog'), 'servicecatalog', 'marketplace')]"
  },
  "resources": [
    {
      "type": "Microsoft.Solutions/applications",
      "apiVersion": "2021-07-01",
      "name": "lag-metrics",
      "kind": "[variables('kind')]",
      "location": "[parameters('location')]",
      "plan": "[if(parameters('serviceCatalog'), null(), createObject('name', 'standard', 'product', 'lag-metrics', 'publisher', 'tbd', 'version', '1.0.0'))]",
      "properties": {
        "managedResourceGroupId": "[variables('managedGroupId')]",
        "applicationDefinitionId": "[if(parameters('serviceCatalog'), '/subscriptions/55c079e7-8c64-4e3d-b797-a71ebda23e81/resourceGroups/lag-metrics-definition/providers/Microsoft.Solutions/applicationDefinitions/lag-metrics/overview', null())]",
        "parameters": {
          "eventHubConnectionString": {
            "value": "[parameters('eventHubConnectionString')]"
          },
          "storageAccountConnectionString": {
            "value": "[parameters('storageAccountConnectionString')]"
          },
          "offsetContainerName": {
            "value": "[parameters('offsetContainerName')]"
          },
          "applicationInsightsConnectionString": {
            "value": "[parameters('applicationInsightsConnectionString')]"
          }
        }
      }
    }
  ]
}